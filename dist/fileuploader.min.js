"use strict";var FileUploader=function(a,b){this.$obj=$(a),this.options=b,this.waterfall=new Waterfall,this.model=[],this.preloadImages(b.images),this.view=new FileUploaderView(this),this.view.init()};FileUploader.prototype.addImagePreloading=function(a,b){var c=null,d=new XMLHttpRequest,e=this,f=null;d.open("GET",e.options.base_url+b.src),d.responseType="blob",d.onload=function(g){c=d.response,c.name=b.name,f=e.addImage(c),f.data=g.target.result,f.value=b.value,f.url=b.src,e.view.showThumb(a,f.value),e.view.updateurl()},d.send()},FileUploader.prototype.preloadImages=function(a){for(var b=0;b<a.length;b++){var c=a[b];this.addImagePreloading(b,c)}},FileUploader.prototype.addImage=function(a){var b=this;if(this.isImage(a.name)){var c=new LPImage({file:a,uploadurl:this.options.uploadurl,response_type:this.options.response_type,thumbnail:this.options.thumbnail,onprogress:function(a){b.view.updateUploadProgress(b.model.indexOf(c),a)},onthumbprogress:function(a){b.view.updateThumbProgress(b.model.indexOf(c),a)},onthumbloaded:function(){b.view.imageDataLoaded(b.model.indexOf(c))},onupdateurl:function(a){b.view.updateurl(b.model.indexOf(c),a),"local"===b.options.thumbnail_origin?b.view.showThumb(b.model.indexOf(c),c.data):b.view.showThumb(b.model.indexOf(c),a)}});return this.options.multi||(this.model=[],this.waterfall.clearImages()),this.model.push(c),this.waterfall.appendImage(c),this.view.addImage(c),c}},FileUploader.prototype.isImage=function(a){return-1!=a.toLowerCase().indexOf(".jpg")||-1!=a.toLowerCase().indexOf(".png")?!0:!1},FileUploader.prototype.getImageList=function(){return this.model},FileUploader.prototype.getInput=function(){return this.$obj},FileUploader.prototype.isready=function(){for(var a=0;a<this.model.length;a++){var b=100==this.model[a].percentComplete;if(!b)return!1}return!0},FileUploader.prototype.getBaseURL=function(){return this.options.base_url},FileUploader.prototype.getImagesData=function(){for(var a=[],b=0;b<this.model.length;b++){var c=this.model[b];""!==c.value&&a.push(c.value)}return a};var FileUploaderTemplates={"imgup-template":'         <div class="imgup">             <ul>             </ul>         </div>',"imgup-image-template":'         <li>             <div class="img-container" >                 <img src="" class="imgup-image" />                 <div class="imgup-progress" >                     <div class="imgup-progress-bar" ></div>                 </div>             </div>         </li>',"imgup-image-add-template":'         <li class="imgup-add-input-container" >             <input type="file" class="imgup-add-input" multiple="multiple" />         </li>'},FileUploaderView=function(a){this.controller=a,this.main_template="",this.img_template="",this.add_img_template="",this.$images=[],this.$main_template=void 0,this.loadTemplates(),this.thumbs_loading=[],this.is_loading=!1,this.$container=$('<div class="imageuploader-container" ></div>')};FileUploaderView.prototype.init=function(){var a=this.controller.getInput();a.css("visibility","hidden"),a.attr("type","text"),a.after(this.$container),this.render()},FileUploaderView.prototype.addInputEvent=function(a){var b=this;a.change(function(a){var c=0,d=a.target.files;for(c=0;c<d.length;c++)b.controller.addImage(d[c])})},FileUploaderView.prototype.addImage=function(a){this.clearImages();var b=$(this.img_template);$.data(b,"lpimage",a),this.applyPercent(b,a.thumbPercent),$(b).insertBefore($(".imgup-add-input-container",this.$main_template)),this.$images.push(b)},FileUploaderView.prototype.loadTemplates=function(){this.main_template=FileUploaderTemplates["imgup-template"],this.img_template=FileUploaderTemplates["imgup-image-template"],this.add_img_template=FileUploaderTemplates["imgup-image-add-template"],""!==this.controller.options.templates.list_container_template&&(this.main_template=$(this.controller.options.templates.list_container_template).html()),""!==this.controller.options.templates.item_template&&(this.img_template=$(this.controller.options.templates.item_template).html()),""!==this.controller.options.templates.input_template&&(this.add_img_template=$(this.controller.options.templates.input_template).html())},FileUploaderView.prototype.clearImages=function(){this.controller.options.multi||($("li",this.$container).each(function(){$(this).hasClass("imgup-add-input-container")||$(this).remove()}),this.$images=[])},FileUploaderView.prototype.render=function(){var a=this;setTimeout(function(){var b=$(a.main_template),c=null;$("ul",b).append($(a.add_img_template)),a.$container.html(b),c=$(".imgup-add-input",b),c.attr("multiple",a.controller.options.multi),a.$main_template=b,a.addInputEvent(c)},10)},FileUploaderView.prototype.updateUploadProgress=function(a,b){this.applyPercent(this.$images[a],b)},FileUploaderView.prototype.updateThumbProgress=function(a,b){this.applyPercent(this.$images[a],b)},FileUploaderView.prototype.imageDataLoaded=function(a){$(".imgup-progress-bar",this.$images[a]).css("opacity",1),$(".imgup-progress-bar",this.$images[a]).css("width",0)},FileUploaderView.prototype.showThumb=function(a,b){var c=this;this.thumbs_loading.push({img:$("img",c.$images[a]),url:b,index:a}),this.loadingThumbgs()},FileUploaderView.prototype.loadingThumbgs=function(){if(!this.is_loading){var a=this;if(this.thumbs_loading.length>0){var b=this.thumbs_loading.shift();return void setTimeout(function(){var c=b.img.clone();c.load(function(){b.img.replaceWith(c),a.loadingThumbgs()}),c.attr("src",a.controller.getBaseURL()+b.url)},500)}this.is_loading=!1}},FileUploaderView.prototype.applyPercent=function(a,b){$(".imgup-progress-bar",a).css("width",b+"%")},FileUploaderView.prototype.updateurl=function(){var a=this.controller.getImagesData(),b=this.controller.getInput();b.val(a)};var Waterfall=function(){this.images=[],this.upload_images=[],this.is_loading=!1,this.is_uploading=!1,this.uploading_counter=0};Waterfall.prototype.clearImages=function(){this.images=[]},Waterfall.prototype.appendImage=function(a){this.images.push(a),this.loadThumbs()},Waterfall.prototype.loadThumbs=function(){if(!this.is_loading){var a=this;if(this.images.length>0){var b=this.images.shift();return this.is_loading=!0,void b.loadThumb(function(){a.is_loading=!1,a.loadThumbs(),a.upload_images.push(b),a.uploadImages()})}this.is_loading=!1}},Waterfall.prototype.uploadImages=function(){if(!(this.is_uploading&&this.uploading_counter>=3)){var a=this;if(this.upload_images.length>0){var b=this.upload_images.shift();return this.is_uploading=!0,this.uploading_counter+=1,void b.upload(function(){a.uploading_counter-=1,a.is_uploading=!1,a.uploadImages()})}this.uploading_counter-=1,this.is_uploading=!1}};var LPImage=function(a){this.name=void 0===a.file.name?"":a.file.name,this.size=void 0===a.file.size?"":a.file.size,this.file=a.file,this.data="",this.value="",this.url="",this.onthumbprogress=void 0===a.onthumbprogress?$.noop():a.onthumbprogress,this.onprogress=void 0===a.onprogress?$.noop():a.onprogress,this.onupdateurl=void 0===a.onupdateurl?$.noop():a.onupdateurl,this.uploadurl=void 0===a.uploadurl?"/":a.uploadurl,this.onthumbloaded=void 0===a.onthumbloaded?$.noop():a.onthumbloaded,this.response_type=void 0===a.response_type?"string":a.response_type,this.thumbnail=void 0===a.thumbnail?"thumbnail":a.thumbnail,this.thumbPercent=0,this.percentComplete=0,""!==this.thumbnail&&(this.response_type="json")};LPImage.prototype.loadThumb=function(a){var b=this,c=new FileReader;c.onload=function(c){b.data=c.target.result,b.onthumbloaded(b.data),setTimeout(function(){a()},100)},c.onprogress=function(a){return a.lengthComputable?(b.thumbPercent=parseInt(a.loaded/a.total*100),void b.onthumbprogress(b.thumbPercent)):void(b.thumbPercent=100)},c.readAsDataURL(this.file)},LPImage.prototype.generateBlob=function(a,b,c){b=b||"",c=c||512;for(var d=a,e=[],f=0;f<d.length;f+=c){for(var g=d.slice(f,f+c),h=new Array(g.length),i=0;i<g.length;i++)h[i]=g.charCodeAt(i);var j=new Uint8Array(h);e.push(j)}var k=new Blob(e,{type:b});return k},LPImage.prototype.upload=function(a){var b=this,c=new FormData;c.append("name",this.name),c.append("size",this.size),c.append("data",this.generateBlob(this.data,"text/plain",512)),$.ajax({contentType:!1,processData:!1,cache:!1,url:b.uploadurl,type:"POST",xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",function(a){var c=a.loaded||a.position;b.percentComplete=Math.ceil(c/a.total*100),b.onprogress(b.percentComplete)},!1),a},beforeSend:function(a,b){b.data=c}}).done(function(c){b.value=c,"string"===b.response_type?(b.url=c,b.onupdateurl(c)):("object"!=typeof c?c=$.parseJSON(c):b.value=JSON.stringify(c),b.url=c[b.thumbnail],b.onupdateurl(c[b.thumbnail])),a()})},function(a,b,c,d){var e="fileuploader",f={isready:function(){var b=!0;return this.each(function(){var c=a.data(this,"plugin_"+e);c.isready()||(b=!1)}),b},loadimages:function(b){this.each(function(){a.data(this,"plugin_"+e).preloadImages(b)})}};a.fn[e]=function(b,c){var d={base_url:"",uploadurl:"/",response_type:"string",thumbnail:"",thumbnail_origin:"local",multi:!0,templates:{list_container_template:"",item_template:"",input_template:""},images:[]};if(f[b])return f[b].call(this,c);c=b;var g=a.extend({},d,c);return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new FileUploader(this,g))})}}(jQuery,window,document);